name: Deploy to Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      # Build Frontend
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Verify build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "Error: frontend/dist directory not found!"
            exit 1
          fi
          echo "Build successful. Contents of dist/:"
          ls -la frontend/dist/

      # Deploy via SSH
      - name: Deploy to Hostinger
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          envs: DEPLOY_PATH
          script: |
            set -e

            echo "=== Deploying to Hostinger ==="
            cd "$DEPLOY_PATH"

            echo "=== Pulling latest changes ==="
            git pull origin main

            echo "=== Building Frontend ==="
            cd frontend
            npm ci
            npm run build

            echo "=== Installing Backend Dependencies ==="
            cd ../backend
            composer install --no-dev --optimize-autoloader
            php bin/console cache:clear --env=prod

            echo "=== Reloading Nginx ==="
            sudo systemctl reload nginx

            echo "=== Deployment Complete ==="
