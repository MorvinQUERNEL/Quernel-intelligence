name: CI/CD - Deploy to RunPod GPU

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Skip tests and deploy directly'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'
  PHP_VERSION: '8.3'

jobs:
  # ================================
  # Frontend - Build & Test
  # ================================
  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Type check
        working-directory: frontend
        run: npm run build
        continue-on-error: false

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # ================================
  # Backend - Validate & Test
  # ================================
  backend:
    name: Backend Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, intl, uuid, mbstring, xml
          coverage: none
          tools: composer:v2

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: backend
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << 'ENVFILE'
          APP_ENV=dev
          APP_SECRET=ci_test_secret_key_not_for_production
          APP_SHARE_DIR=var/share
          DEFAULT_URI=http://localhost
          JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
          JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
          JWT_PASSPHRASE=ci_test_passphrase
          MAILER_DSN=null://null
          DATABASE_URL="postgresql://app:test@127.0.0.1:5432/app?serverVersion=16&charset=utf8"
          CORS_ALLOW_ORIGIN='^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$'
          ENVFILE

      - name: Install dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Validate Symfony
        working-directory: backend
        run: |
          php bin/console lint:yaml config/
          php bin/console lint:container
        continue-on-error: true

  # ================================
  # Deploy to RunPod
  # ================================
  deploy:
    name: Deploy to RunPod
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.RUNPOD_SSH_KEY }}" > ~/.ssh/runpod_key
          chmod 600 ~/.ssh/runpod_key

          # Add host to known hosts
          ssh-keyscan -p ${{ secrets.RUNPOD_PORT }} ${{ secrets.RUNPOD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          # Create SSH config
          cat >> ~/.ssh/config << EOF
          Host runpod
            HostName ${{ secrets.RUNPOD_HOST }}
            Port ${{ secrets.RUNPOD_PORT }}
            User root
            IdentityFile ~/.ssh/runpod_key
            StrictHostKeyChecking no
          EOF

      - name: Create deployment directory
        run: |
          ssh runpod "mkdir -p /workspace/saas/{backend,frontend}"

      - name: Deploy Backend
        run: |
          rsync -avz --delete \
            --exclude 'vendor/' \
            --exclude 'var/' \
            --exclude '.env.local' \
            --exclude 'config/jwt/*.pem' \
            --exclude '.git/' \
            -e "ssh" \
            backend/ runpod:/workspace/saas/backend/

      - name: Deploy Frontend
        run: |
          rsync -avz --delete \
            -e "ssh" \
            frontend/dist/ runpod:/workspace/saas/frontend/

      - name: Post-deployment setup
        run: |
          ssh runpod 'set -e && cd /workspace/saas/backend && \
            echo "=== Installing PHP dependencies ===" && \
            if ! command -v php > /dev/null 2>&1; then \
              apt-get update && \
              apt-get install -y php8.3 php8.3-cli php8.3-pgsql php8.3-xml php8.3-mbstring php8.3-intl php8.3-uuid php8.3-curl php8.3-fpm nginx; \
            fi && \
            if ! command -v composer > /dev/null 2>&1; then \
              curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer; \
            fi && \
            echo "=== Installing Composer packages ===" && \
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev && \
            echo "=== Setting up environment ===" && \
            echo "APP_ENV=prod" > .env.local && \
            echo "APP_SECRET=$(openssl rand -hex 32)" >> .env.local && \
            echo "DATABASE_URL=postgresql://quernel:quernel_secret_2026@localhost:5432/quernel_db?serverVersion=14" >> .env.local && \
            echo "VLLM_API_URL=http://localhost:8000/v1" >> .env.local && \
            echo "CORS_ALLOW_ORIGIN=^https?://(localhost|127\\.0\\.0\\.1|.*\\.runpod\\.io)(:[0-9]+)?$" >> .env.local && \
            echo "=== Generating JWT keys ===" && \
            if [ ! -f config/jwt/private.pem ]; then \
              mkdir -p config/jwt && \
              JWT_PASS=$(openssl rand -hex 16) && \
              openssl genpkey -out config/jwt/private.pem -aes256 -algorithm rsa -pkeyopt rsa_keygen_bits:4096 -pass pass:$JWT_PASS && \
              openssl pkey -in config/jwt/private.pem -out config/jwt/public.pem -pubout -passin pass:$JWT_PASS && \
              echo "JWT_PASSPHRASE=$JWT_PASS" >> .env.local; \
            fi && \
            echo "=== Running database migrations ===" && \
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod || true && \
            echo "=== Loading fixtures if database is empty ===" && \
            php bin/console doctrine:fixtures:load --no-interaction --env=prod --append || true && \
            echo "=== Clearing cache ===" && \
            php bin/console cache:clear --env=prod && \
            php bin/console cache:warmup --env=prod && \
            echo "=== Setting permissions ===" && \
            chmod -R 777 var/ && \
            echo "=== Deployment complete! ==="'

      - name: Configure Nginx
        run: |
          ssh runpod 'cat > /etc/nginx/sites-available/quernel << NGINXEOF
          server {
              listen 8080;
              server_name _;
              root /workspace/saas/backend/public;
              location / {
                  try_files \$uri /index.php\$is_args\$args;
              }
              location ~ ^/index\\.php(/|\$) {
                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                  fastcgi_split_path_info ^(.+\\.php)(/.*)$;
                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
                  fastcgi_param DOCUMENT_ROOT \$realpath_root;
                  internal;
              }
              location ~ \\.php\$ {
                  return 404;
              }
          }
          server {
              listen 3000;
              server_name _;
              root /workspace/saas/frontend;
              index index.html;
              location / {
                  try_files \$uri \$uri/ /index.html;
              }
          }
          NGINXEOF'

      - name: Start services
        run: |
          ssh runpod 'ln -sf /etc/nginx/sites-available/quernel /etc/nginx/sites-enabled/ && \
            rm -f /etc/nginx/sites-enabled/default && \
            service php8.3-fpm restart || true && \
            service nginx restart || true && \
            echo "Backend API: http://localhost:8080" && \
            echo "Frontend: http://localhost:3000" && \
            echo "vLLM: http://localhost:8000"'

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/runpod_key

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to:** RunPod GPU" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
